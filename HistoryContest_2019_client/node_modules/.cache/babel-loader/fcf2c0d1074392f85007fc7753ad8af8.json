{"ast":null,"code":"import _objectWithoutProperties from 'babel-runtime/helpers/objectWithoutProperties';\nimport _extends from 'babel-runtime/helpers/extends';\nimport _classCallCheck from 'babel-runtime/helpers/classCallCheck';\nimport _createClass from 'babel-runtime/helpers/createClass';\nimport _possibleConstructorReturn from 'babel-runtime/helpers/possibleConstructorReturn';\nimport _inherits from 'babel-runtime/helpers/inherits';\nimport React, { Component } from 'react';\nimport PropTypes from 'prop-types';\nimport ReactDOM from 'react-dom';\nimport TweenOne, { ticker } from 'rc-tween-one';\nimport easeTween from 'tween-functions';\nimport { getGsapType, isConvert, stylesToCss, checkStyleName } from 'style-utils';\nimport BgElement from './BgElement';\nimport { currentScrollTop, currentScrollLeft, dataToArray, toArrayChildren, setAnimCompToTagComp } from './utils';\nimport animType from './anim';\n\nfunction noop() {}\n\nvar Element = function (_Component) {\n  _inherits(Element, _Component);\n\n  function Element(props) {\n    _classCallCheck(this, Element);\n\n    var _this = _possibleConstructorReturn(this, (Element.__proto__ || Object.getPrototypeOf(Element)).call(this, props));\n\n    _initialiseProps.call(_this);\n\n    _this.state = {\n      show: props.show\n    };\n    _this.tickerId = -1;\n    _this.enterMouse = null;\n    _this.delayTimeout = null;\n    _this.followParallax = props.followParallax;\n    _this.transform = checkStyleName('transform');\n    return _this;\n  }\n\n  _createClass(Element, [{\n    key: 'componentDidMount',\n    value: function componentDidMount() {\n      this.dom = ReactDOM.findDOMNode(this);\n    }\n  }, {\n    key: 'componentWillReceiveProps',\n    value: function componentWillReceiveProps(nextProps) {\n      if (this.tickerId !== -1) {\n        ticker.clear(this.tickerId);\n        this.tickerId = -1;\n      }\n\n      var followParallax = nextProps.followParallax;\n\n      if (this.followParallax && !followParallax) {\n        this.reFollowParallax();\n      } else {\n        this.followParallax = followParallax;\n      }\n\n      this.setState({\n        mouseMoveType: nextProps.mouseMoveType\n      });\n    }\n  }, {\n    key: 'componentDidUpdate',\n    value: function componentDidUpdate() {\n      if (this.followParallax) {\n        this.doms = this.followParallax.data.map(function (item) {\n          return document.getElementById(item.id);\n        });\n      }\n    }\n  }, {\n    key: 'componentWillUnmount',\n    value: function componentWillUnmount() {\n      ticker.clear(this.timeoutID);\n      ticker.clear(this.delayTimeout);\n      this.delayTimeout = -1;\n      this.timeoutID = -1;\n    }\n  }, {\n    key: 'render',\n    value: function render() {\n      var props = _extends({}, this.props, this.props.componentProps);\n\n      var style = _extends({}, props.style);\n\n      var show = props.show;\n      style.display = show ? 'block' : 'none';\n      style.position = 'absolute';\n      style.width = '100%';\n\n      if (this.props.mouseMoveType !== 'end') {\n        style[this.transform] = '';\n      }\n\n      props.style = style;\n      props.className = ('banner-anim-elem ' + (this.props.prefixCls || '')).trim();\n      var bgElem = toArrayChildren(this.props.children).filter(function (item) {\n        return item && item.type.isBannerAnimBgElement;\n      }).map(function (item) {\n        return React.cloneElement(item, {\n          show: props.show\n        });\n      });\n      ['prefixCls', 'callBack', 'animType', 'duration', 'delay', 'ease', 'elemOffset', 'followParallax', 'show', 'type', 'direction', 'leaveChildHide', 'sync', 'ratio', 'mouseMoveType'].forEach(function (key) {\n        return delete props[key];\n      });\n\n      if (this.state.show === show && !this.state.mouseMoveType || this.state.mouseMoveType === 'reChild') {\n        props.animation = {\n          x: 0,\n          y: 0,\n          type: 'set'\n        };\n\n        if (!show) {\n          this.enterMouse = null;\n          return React.createElement(TweenOne, props, bgElem);\n        }\n\n        if (this.props.followParallax) {\n          props.onMouseMove = this.getFollowMouseMove();\n        }\n\n        return React.createElement(TweenOne, props, this.props.mouseMoveType === 'update' ? bgElem : this.getChildren());\n      }\n\n      return this.animChildren(props, style, bgElem);\n    }\n  }]);\n\n  return Element;\n}(Component);\n\nvar _initialiseProps = function _initialiseProps() {\n  var _this2 = this;\n\n  this.onMouseMove = function (e) {\n    _this2.domRect = _this2.dom.getBoundingClientRect();\n    _this2.enterMouse = _this2.enterMouse || {\n      x: _this2.domRect.width / 2,\n      y: _this2.domRect.height / 2\n    };\n    _this2.domWH = {\n      w: _this2.domRect.width,\n      h: _this2.domRect.height\n    };\n    _this2.offsetTop = _this2.domRect.top + currentScrollTop();\n    _this2.offsetLeft = _this2.domRect.left + currentScrollLeft();\n    var mouseXY = {\n      x: e.pageX - _this2.offsetLeft,\n      y: e.pageY - _this2.offsetTop\n    };\n\n    _this2.setTicker(_this2.followParallax, mouseXY);\n  };\n\n  this.setTicker = function (followParallax, mouseXY) {\n    var callback = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : noop;\n    ticker.clear(_this2.tickerId);\n    _this2.tickerId = 'bannerElementTicker' + (Date.now() + Math.random());\n    var startFrame = ticker.frame;\n    var startX = _this2.enterMouse.x;\n    var startY = _this2.enterMouse.y;\n    var duration = followParallax.duration || 450;\n    var easeFunc = easeTween[followParallax.ease || 'easeOutQuad'];\n    var start = typeof followParallax.minMove === 'number' ? followParallax.minMove : 0.08;\n    ticker.wake(_this2.tickerId, function () {\n      var moment = (ticker.frame - startFrame) * ticker.perFrame;\n      var ratio = easeFunc(moment, start, 1, duration);\n      _this2.enterMouse.x = startX + (mouseXY.x - startX) * ratio;\n      _this2.enterMouse.y = startY + (mouseXY.y - startY) * ratio;\n\n      _this2.setFollowStyle(_this2.domWH);\n\n      if (moment >= duration) {\n        ticker.clear(_this2.tickerId);\n        callback();\n      }\n    });\n  };\n\n  this.getFollowMouseMove = function () {\n    var onMouseMove = void 0;\n\n    if (_this2.followParallax) {\n      if (_this2.followParallax.delay) {\n        onMouseMove = !_this2.delayTimeout ? null : _this2.state.onMouseMove;\n        _this2.delayTimeout = _this2.delayTimeout || ticker.timeout(function () {\n          _this2.setState({\n            onMouseMove: _this2.onMouseMove\n          });\n        }, _this2.followParallax.delay);\n      } else {\n        onMouseMove = _this2.onMouseMove;\n      }\n    }\n\n    return onMouseMove;\n  };\n\n  this.getFollowStyle = function (data, domWH) {\n    var style = {};\n    dataToArray(data.type).forEach(function (type) {\n      var mouseData = _this2.enterMouse.x;\n      var domData = domWH.w;\n      var value = data.value;\n\n      if ((type.indexOf('y') >= 0 || type.indexOf('Y') >= 0) && type !== 'opacity') {\n        mouseData = _this2.enterMouse.y;\n        domData = domWH.h;\n      }\n\n      var d = (mouseData - domData / 2) / (domData / 2) * value;\n\n      var _type = getGsapType(type);\n\n      var cssName = isConvert(_type);\n\n      if (cssName === 'transform') {\n        var transform = checkStyleName('transform');\n        style[transform] = style[transform] || {};\n        style[transform][_type] = stylesToCss(_type, d).trim();\n      } else if (cssName === 'filter') {\n        var filter = checkStyleName('filter');\n        style[filter] = style[filter] || {};\n        style[filter][_type] = stylesToCss(_type, d).trim();\n      } else {\n        style[cssName] = stylesToCss(_type, d).trim();\n      }\n    });\n    return style;\n  };\n\n  this.setFollowStyle = function (domWH) {\n    _this2.doms.forEach(function (item, i) {\n      if (!item) {\n        return;\n      }\n\n      var data = _this2.followParallax.data[i];\n\n      var style = _this2.getFollowStyle(data, domWH);\n\n      Object.keys(style).forEach(function (key) {\n        if (typeof style[key] === 'object') {\n          var styleStr = '';\n          Object.keys(style[key]).forEach(function (_key) {\n            styleStr += (' ' + _key + '(' + style[key][_key] + ')').trim();\n          });\n          item.style[key] = styleStr;\n          return;\n        }\n\n        item.style[key] = key.indexOf('backgroundPosition') >= 0 ? 'calc(' + (data.bgPosition || '0%') + ' + ' + style[key] + ' )' : style[key];\n      });\n    });\n  };\n\n  this.getChildren = function () {\n    return toArrayChildren(_this2.props.children).map(function (item, i) {\n      if (item && item.type === BgElement) {\n        return React.cloneElement(item, {\n          show: _this2.state.show\n        });\n      }\n\n      return _this2.useTagComp ? setAnimCompToTagComp(item, i) : item;\n    });\n  };\n\n  this.reFollowParallax = function () {\n    if (!_this2.domRect) {\n      return;\n    }\n\n    _this2.setTicker(_this2.followParallax, {\n      x: _this2.domRect.width / 2 - _this2.offsetLeft,\n      y: _this2.domRect.height / 2 - _this2.offsetTop\n    }, function () {\n      _this2.followParallax = null;\n    });\n  };\n\n  this.animEnd = function () {\n    var type = _this2.state.show ? 'enter' : 'leave';\n\n    _this2.props.callBack(type);\n\n    _this2.setState(function (_, props) {\n      return {\n        show: props.show,\n        mouseMoveType: null\n      };\n    });\n  };\n\n  this.animChildren = function (props, style, bgElem) {\n    var _props = _this2.props,\n        elemOffset = _props.elemOffset,\n        leaveChildHide = _props.leaveChildHide,\n        ratio = _props.ratio,\n        currentAnimType = _props.animType,\n        direction = _props.direction,\n        mouseMoveType = _props.mouseMoveType,\n        ease = _props.ease,\n        duration = _props.duration,\n        delay = _props.delay,\n        show = _props.show,\n        sync = _props.sync,\n        component = _props.component;\n\n    if (_this2.tickerId) {\n      ticker.clear(_this2.tickerId);\n    }\n\n    if (_this2.delayTimeout) {\n      ticker.clear(_this2.delayTimeout);\n      _this2.delayTimeout = null;\n    }\n\n    style.display = 'block';\n    props.component = component;\n    style.zIndex = show ? 1 : 0;\n    var type = show ? 'enter' : 'leave';\n    _this2.useTagComp = (currentAnimType === animType.gridBar || currentAnimType === animType.grid) && (show === _this2.state.show || _this2.state.show && !show); // 状态没改，锁定 children \n\n    props.children = !sync && (show && show !== _this2.state.show || !show && !_this2.state.show) ? bgElem : _this2.getChildren();\n    var childrenToRender = React.createElement(TweenOne, props);\n    var $ratio = mouseMoveType === 'end' && ratio <= 0.3 ? 1 - ratio : ratio;\n    var tag = currentAnimType(childrenToRender, type, direction, {\n      ease: ease,\n      duration: duration,\n      delay: delay,\n      onComplete: _this2.animEnd\n    }, elemOffset, leaveChildHide, $ratio, _this2.state.mouseMoveType === 'update');\n\n    var tagProps = _objectWithoutProperties(tag.props, []);\n\n    if (tagProps.animation) {\n      tagProps.moment = (tagProps.animation.duration + tagProps.animation.delay) * $ratio || 0;\n      tagProps.paused = _this2.state.mouseMoveType === 'update' || $ratio === 1;\n    }\n\n    return React.cloneElement(tag, tagProps);\n  };\n};\n\nElement.propTypes = {\n  children: PropTypes.any,\n  style: PropTypes.object,\n  prefixCls: PropTypes.string,\n  component: PropTypes.any,\n  elemOffset: PropTypes.object,\n  type: PropTypes.string,\n  animType: PropTypes.func,\n  ease: PropTypes.string,\n  duration: PropTypes.number,\n  delay: PropTypes.number,\n  direction: PropTypes.string,\n  callBack: PropTypes.func,\n  followParallax: PropTypes.any,\n  show: PropTypes.bool,\n  leaveChildHide: PropTypes.bool,\n  sync: PropTypes.bool,\n  ratio: PropTypes.number,\n  mouseMoveType: PropTypes.string,\n  componentProps: PropTypes.object\n};\nElement.defaultProps = {\n  component: 'div',\n  componentProps: {},\n  callBack: noop,\n  delay: 0\n};\nElement.BgElement = BgElement;\nElement.isBannerAnimElement = true;\nexport default Element;","map":null,"metadata":{},"sourceType":"module"}